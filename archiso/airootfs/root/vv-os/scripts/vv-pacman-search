#!/bin/bash
# VV OS - Pacman Package Search (TUI)
# Search packages –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö Arch Linux

set -e

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
if ! command -v gum &>/dev/null; then
    notify-send "VV Package Search" "gum –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" -u critical
    exit 1
fi

if ! command -v paru &>/dev/null && ! command -v yay &>/dev/null; then
    notify-send "VV Package Search" "AUR helper –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (paru/yay)" -u critical
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º AUR helper
if command -v paru &>/dev/null; then
    AUR_HELPER="paru"
else
    AUR_HELPER="yay"
fi

# –ó–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
QUERY=$(gum input --placeholder "Enter package name –¥–ª—è –ø–æ–∏—Å–∫–∞..." --prompt "üîç ")

if [[ -z "$QUERY" ]]; then
    exit 0
fi

# Search packages –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö
gum spin --spinner dot --title "–ü–æ–∏—Å–∫ '$QUERY' –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö..." -- sleep 0.5

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤
PACKAGES=$(pacman -Ss "$QUERY" 2>/dev/null | grep -E "^[a-z]" | cut -d'/' -f2 | cut -d' ' -f1 | sort -u)

if [[ -z "$PACKAGES" ]]; then
    gum style --foreground 196 "‚ùå –ü–∞–∫–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö"
    gum confirm "–ò—Å–∫–∞—Ç—å –≤ AUR?" && exec vv-aur-search
    exit 0
fi

# –í—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞
SELECTED=$(echo "$PACKAGES" | gum filter --placeholder "Select package...")

if [[ -z "$SELECTED" ]]; then
    exit 0
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–∫–µ—Ç–µ
clear
gum style \
    --border double \
    --border-foreground 212 \
    --padding "1 2" \
    --margin "1 0" \
    "üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–∫–µ—Ç–µ: $SELECTED"

pacman -Si "$SELECTED" | gum format

echo ""

# –î–µ–π—Å—Ç–≤–∏—è —Å –ø–∞–∫–µ—Ç–æ–º
ACTION=$(gum choose "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" "–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∞–π–ª—ã" "–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏" "–ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–∞–∫–µ—Ç" "–í—ã—Ö–æ–¥")

case "$ACTION" in
    "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å")
        gum confirm "Install $SELECTED?" && $AUR_HELPER -S "$SELECTED"
        ;;
    "–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∞–π–ª—ã")
        pacman -Fl "$SELECTED" | less
        ;;
    "–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏")
        pactree "$SELECTED" | less
        ;;
    "–ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–∞–∫–µ—Ç")
        exec "$0"
        ;;
    "–í—ã—Ö–æ–¥")
        exit 0
        ;;
esac

#!/bin/bash
# VV OS - Package Manager (TUI)
# Main package management menu

set -e

# Check dependencies
if ! command -v gum &>/dev/null; then
    notify-send "VV Package Manager" "gum is not installed" -u critical
    exit 1
fi

if ! command -v paru &>/dev/null && ! command -v yay &>/dev/null; then
    notify-send "VV Package Manager" "AUR helper is not installed (paru/yay)" -u critical
    exit 1
fi

# Detect AUR helper
if command -v paru &>/dev/null; then
    AUR_HELPER="paru"
else
    AUR_HELPER="yay"
fi

# Main menu
while true; do
    clear

    gum style \
        --border double \
        --border-foreground 213 \
        --padding "1 2" \
        --margin "1 0" \
        --align center \
        "üì¶ VV Package Manager"

    echo ""

    ACTION=$(gum choose \
        "üîç Search packages (Official)" \
        "üîç Search packages (AUR)" \
        "üîç Search packages (Flatpak)" \
        "‚¨ÜÔ∏è  Update system" \
        "ü™û Update mirrors (rate-mirrors)" \
        "üßπ Clean package cache" \
        "üóëÔ∏è  Remove orphan packages" \
        "üìä Show installed packages" \
        "üóëÔ∏è  Remove package" \
        "‚ÑπÔ∏è  System information" \
        "‚ùå Exit")

    case "$ACTION" in
        "üîç Search packages (Official)")
            vv-pacman-search
            ;;
        "üîç Search packages (AUR)")
            vv-aur-search
            ;;
        "üîç Search packages (Flatpak)")
            vv-flatpak-search
            ;;
        "‚¨ÜÔ∏è  Update system")
            clear
            gum style --foreground 212 "‚¨ÜÔ∏è  Updating system..."
            echo ""
            gum confirm "Update all packages?" && $AUR_HELPER -Syu
            ;;
        "ü™û Update mirrors (rate-mirrors)")
            clear
            gum style --foreground 213 "ü™û Updating mirrors via rate-mirrors..."
            echo ""
            gum style --foreground 214 "‚ö†Ô∏è  Requires sudo privileges"
            echo ""
            if gum confirm "Update mirrorlist?"; then
                sudo /usr/local/bin/update-mirrors.sh
                gum style --foreground 46 "‚úÖ Mirrors updated!"
                sleep 2
            fi
            ;;
        "üßπ Clean package cache")
            clear
            gum style --foreground 214 "üßπ Cleaning package cache..."
            echo ""

            # Show cache size
            CACHE_SIZE=$(du -sh /var/cache/pacman/pkg 2>/dev/null | cut -f1)
            gum style "Cache size: $CACHE_SIZE"
            echo ""

            gum confirm "Clean package cache?" && sudo pacman -Scc --noconfirm
            gum style --foreground 46 "‚úÖ Cache cleaned"
            sleep 2
            ;;
        "üóëÔ∏è  Remove orphan packages")
            clear
            gum style --foreground 214 "üóëÔ∏è  Orphan packages (no longer needed dependencies)"
            echo ""

            ORPHANS=$(pacman -Qtdq 2>/dev/null)

            if [[ -z "$ORPHANS" ]]; then
                gum style --foreground 46 "‚úÖ No orphan packages found"
                sleep 2
            else
                ORPHAN_COUNT=$(echo "$ORPHANS" | wc -l)
                gum style "Found orphan packages: $ORPHAN_COUNT"
                echo ""
                echo "$ORPHANS" | gum format
                echo ""

                if gum confirm "Remove all orphan packages?"; then
                    sudo pacman -Rns $(pacman -Qtdq) --noconfirm
                    gum style --foreground 46 "‚úÖ Orphan packages removed"
                    sleep 2
                fi
            fi
            ;;
        "üìä Show installed packages")
            clear
            gum style --foreground 213 "üìä Installed packages"
            echo ""

            INSTALLED=$(pacman -Qq | wc -l)
            EXPLICIT=$(pacman -Qe | wc -l)
            FOREIGN=$(pacman -Qm | wc -l)

            gum style \
                "Total packages: $INSTALLED" \
                "Explicitly installed: $EXPLICIT" \
                "From AUR: $FOREIGN"
            echo ""

            gum choose "Show all packages" "Show explicitly installed" "Show AUR packages" "Back" | {
                read CHOICE
                case "$CHOICE" in
                    "Show all packages")
                        pacman -Qq | less
                        ;;
                    "Show explicitly installed")
                        pacman -Qe | less
                        ;;
                    "Show AUR packages")
                        pacman -Qm | less
                        ;;
                esac
            }
            ;;
        "üóëÔ∏è  Remove package")
            PACKAGE=$(pacman -Qq | gum filter --placeholder "Select package to remove...")
            if [[ -n "$PACKAGE" ]]; then
                gum confirm "Remove $PACKAGE?" && sudo pacman -Rns "$PACKAGE"
            fi
            ;;
        "‚ÑπÔ∏è  System information")
            clear
            gum style \
                --border double \
                --border-foreground 213 \
                --padding "1 2" \
                --margin "1 0" \
                "‚ÑπÔ∏è  System information"
            echo ""

            echo "üêß Distribution: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'=' -f2 | tr -d '\"')"
            echo "üîß Kernel version: $(uname -r)"
            echo "üíæ RAM: $(free -h | grep Mem | awk '{print $3 " / " $2}')"
            echo "üíø Disk: $(df -h / | tail -1 | awk '{print $3 " / " $2 " (" $5 " used)"}')"
            echo ""

            gum input --placeholder "Press Enter to continue..." > /dev/null
            ;;
        "‚ùå Exit")
            exit 0
            ;;
    esac
done

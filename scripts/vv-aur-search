#!/bin/bash
# VV OS - AUR Package Search (TUI)
# –ü–æ–∏—Å–∫ –ø–∞–∫–µ—Ç–æ–≤ –≤ Arch User Repository

set -e

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
if ! command -v gum &>/dev/null; then
    notify-send "VV AUR Search" "gum –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" -u critical
    exit 1
fi

if ! command -v paru &>/dev/null && ! command -v yay &>/dev/null; then
    notify-send "VV AUR Search" "AUR helper –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (paru/yay)" -u critical
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º AUR helper
if command -v paru &>/dev/null; then
    AUR_HELPER="paru"
else
    AUR_HELPER="yay"
fi

# –ó–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
QUERY=$(gum input --placeholder "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ AUR..." --prompt "üîç AUR: ")

if [[ -z "$QUERY" ]]; then
    exit 0
fi

# –ü–æ–∏—Å–∫ –ø–∞–∫–µ—Ç–æ–≤ –≤ AUR
gum spin --spinner dot --title "–ü–æ–∏—Å–∫ '$QUERY' –≤ AUR..." -- sleep 0.5

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤ –∏–∑ AUR
PACKAGES=$($AUR_HELPER -Ss --aur "$QUERY" 2>/dev/null | grep -E "^aur/" | cut -d'/' -f2 | cut -d' ' -f1 | sort -u)

if [[ -z "$PACKAGES" ]]; then
    gum style --foreground 196 "‚ùå –ü–∞–∫–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ AUR"
    gum confirm "–ò—Å–∫–∞—Ç—å –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö?" && exec vv-pacman-search
    exit 0
fi

# –í—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞
SELECTED=$(echo "$PACKAGES" | gum filter --placeholder "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç –∏–∑ AUR...")

if [[ -z "$SELECTED" ]]; then
    exit 0
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–∫–µ—Ç–µ
clear
gum style \
    --border double \
    --border-foreground 214 \
    --padding "1 2" \
    --margin "1 0" \
    "üì¶ AUR –ø–∞–∫–µ—Ç: $SELECTED"

$AUR_HELPER -Si --aur "$SELECTED" | gum format

echo ""

# –î–µ–π—Å—Ç–≤–∏—è —Å –ø–∞–∫–µ—Ç–æ–º
ACTION=$(gum choose "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" "–ü–æ–∫–∞–∑–∞—Ç—å PKGBUILD" "–û—Ç–∫—Ä—ã—Ç—å AUR —Å—Ç—Ä–∞–Ω–∏—Ü—É" "–ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–∞–∫–µ—Ç" "–í—ã—Ö–æ–¥")

case "$ACTION" in
    "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å")
        gum confirm "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å $SELECTED –∏–∑ AUR?" && $AUR_HELPER -S --aur "$SELECTED"
        ;;
    "–ü–æ–∫–∞–∑–∞—Ç—å PKGBUILD")
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º PKGBUILD —á–µ—Ä–µ–∑ AUR helper
        PKGBUILD_URL="https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=$SELECTED"
        curl -sL "$PKGBUILD_URL" | less
        ;;
    "–û—Ç–∫—Ä—ã—Ç—å AUR —Å—Ç—Ä–∞–Ω–∏—Ü—É")
        xdg-open "https://aur.archlinux.org/packages/$SELECTED" &
        ;;
    "–ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–∞–∫–µ—Ç")
        exec "$0"
        ;;
    "–í—ã—Ö–æ–¥")
        exit 0
        ;;
esac

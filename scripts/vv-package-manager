#!/bin/bash
# VV OS - Package Manager (TUI)
# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–∞–º–∏

set -e

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
if ! command -v gum &>/dev/null; then
    notify-send "VV Package Manager" "gum –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" -u critical
    exit 1
fi

if ! command -v paru &>/dev/null && ! command -v yay &>/dev/null; then
    notify-send "VV Package Manager" "AUR helper –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (paru/yay)" -u critical
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º AUR helper
if command -v paru &>/dev/null; then
    AUR_HELPER="paru"
else
    AUR_HELPER="yay"
fi

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
while true; do
    clear

    gum style \
        --border double \
        --border-foreground 213 \
        --padding "1 2" \
        --margin "1 0" \
        --align center \
        "üì¶ VV Package Manager"

    echo ""

    ACTION=$(gum choose \
        "üîç –ü–æ–∏—Å–∫ –ø–∞–∫–µ—Ç–æ–≤ (Official)" \
        "üîç –ü–æ–∏—Å–∫ –ø–∞–∫–µ—Ç–æ–≤ (AUR)" \
        "‚¨ÜÔ∏è  –û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É" \
        "ü™û –û–±–Ω–æ–≤–∏—Ç—å –∑–µ—Ä–∫–∞–ª–∞ (rate-mirrors)" \
        "üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –ø–∞–∫–µ—Ç–æ–≤" \
        "üóëÔ∏è  –£–¥–∞–ª–∏—Ç—å orphan –ø–∞–∫–µ—Ç—ã" \
        "üìä –ü–æ–∫–∞–∑–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã" \
        "üóëÔ∏è  –£–¥–∞–ª–∏—Ç—å –ø–∞–∫–µ—Ç" \
        "‚ÑπÔ∏è  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ" \
        "‚ùå –í—ã—Ö–æ–¥")

    case "$ACTION" in
        "üîç –ü–æ–∏—Å–∫ –ø–∞–∫–µ—Ç–æ–≤ (Official)")
            vv-pacman-search
            ;;
        "üîç –ü–æ–∏—Å–∫ –ø–∞–∫–µ—Ç–æ–≤ (AUR)")
            vv-aur-search
            ;;
        "‚¨ÜÔ∏è  –û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É")
            clear
            gum style --foreground 212 "‚¨ÜÔ∏è  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
            echo ""
            gum confirm "–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø–∞–∫–µ—Ç—ã?" && $AUR_HELPER -Syu
            ;;
        "ü™û –û–±–Ω–æ–≤–∏—Ç—å –∑–µ—Ä–∫–∞–ª–∞ (rate-mirrors)")
            clear
            gum style --foreground 213 "ü™û –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–µ—Ä–∫–∞–ª —á–µ—Ä–µ–∑ rate-mirrors..."
            echo ""
            gum style --foreground 214 "‚ö†Ô∏è  –¢—Ä–µ–±—É—é—Ç—Å—è sudo –ø—Ä–∞–≤–∞"
            echo ""
            if gum confirm "–û–±–Ω–æ–≤–∏—Ç—å mirrorlist?"; then
                sudo /usr/local/bin/update-mirrors.sh
                gum style --foreground 46 "‚úÖ –ó–µ—Ä–∫–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!"
                sleep 2
            fi
            ;;
        "üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –ø–∞–∫–µ—Ç–æ–≤")
            clear
            gum style --foreground 214 "üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–∞–∫–µ—Ç–æ–≤..."
            echo ""

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞
            CACHE_SIZE=$(du -sh /var/cache/pacman/pkg 2>/dev/null | cut -f1)
            gum style "–†–∞–∑–º–µ—Ä –∫—ç—à–∞: $CACHE_SIZE"
            echo ""

            gum confirm "–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –ø–∞–∫–µ—Ç–æ–≤?" && sudo pacman -Scc --noconfirm
            gum style --foreground 46 "‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω"
            sleep 2
            ;;
        "üóëÔ∏è  –£–¥–∞–ª–∏—Ç—å orphan –ø–∞–∫–µ—Ç—ã")
            clear
            gum style --foreground 214 "üóëÔ∏è  Orphan –ø–∞–∫–µ—Ç—ã (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)"
            echo ""

            ORPHANS=$(pacman -Qtdq 2>/dev/null)

            if [[ -z "$ORPHANS" ]]; then
                gum style --foreground 46 "‚úÖ Orphan –ø–∞–∫–µ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
                sleep 2
            else
                ORPHAN_COUNT=$(echo "$ORPHANS" | wc -l)
                gum style "–ù–∞–π–¥–µ–Ω–æ orphan –ø–∞–∫–µ—Ç–æ–≤: $ORPHAN_COUNT"
                echo ""
                echo "$ORPHANS" | gum format
                echo ""

                if gum confirm "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ orphan –ø–∞–∫–µ—Ç—ã?"; then
                    sudo pacman -Rns $(pacman -Qtdq) --noconfirm
                    gum style --foreground 46 "‚úÖ Orphan –ø–∞–∫–µ—Ç—ã —É–¥–∞–ª–µ–Ω—ã"
                    sleep 2
                fi
            fi
            ;;
        "üìä –ü–æ–∫–∞–∑–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã")
            clear
            gum style --foreground 213 "üìä –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã"
            echo ""

            INSTALLED=$(pacman -Qq | wc -l)
            EXPLICIT=$(pacman -Qe | wc -l)
            FOREIGN=$(pacman -Qm | wc -l)

            gum style \
                "–í—Å–µ–≥–æ –ø–∞–∫–µ—Ç–æ–≤: $INSTALLED" \
                "–Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö: $EXPLICIT" \
                "–ò–∑ AUR: $FOREIGN"
            echo ""

            gum choose "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–∞–∫–µ—Ç—ã" "–ü–æ–∫–∞–∑–∞—Ç—å —è–≤–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ" "–ü–æ–∫–∞–∑–∞—Ç—å AUR –ø–∞–∫–µ—Ç—ã" "–ù–∞–∑–∞–¥" | {
                read CHOICE
                case "$CHOICE" in
                    "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–∞–∫–µ—Ç—ã")
                        pacman -Qq | less
                        ;;
                    "–ü–æ–∫–∞–∑–∞—Ç—å —è–≤–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ")
                        pacman -Qe | less
                        ;;
                    "–ü–æ–∫–∞–∑–∞—Ç—å AUR –ø–∞–∫–µ—Ç—ã")
                        pacman -Qm | less
                        ;;
                esac
            }
            ;;
        "üóëÔ∏è  –£–¥–∞–ª–∏—Ç—å –ø–∞–∫–µ—Ç")
            PACKAGE=$(pacman -Qq | gum filter --placeholder "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è...")
            if [[ -n "$PACKAGE" ]]; then
                gum confirm "–£–¥–∞–ª–∏—Ç—å $PACKAGE?" && sudo pacman -Rns "$PACKAGE"
            fi
            ;;
        "‚ÑπÔ∏è  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ")
            clear
            gum style \
                --border double \
                --border-foreground 213 \
                --padding "1 2" \
                --margin "1 0" \
                "‚ÑπÔ∏è  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ"
            echo ""

            echo "üêß –î–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'=' -f2 | tr -d '\"')"
            echo "üîß –í–µ—Ä—Å–∏—è —è–¥—Ä–∞: $(uname -r)"
            echo "üíæ RAM: $(free -h | grep Mem | awk '{print $3 " / " $2}')"
            echo "üíø –î–∏—Å–∫: $(df -h / | tail -1 | awk '{print $3 " / " $2 " (" $5 " –∑–∞–Ω—è—Ç–æ)"}')"
            echo ""

            gum input --placeholder "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..." > /dev/null
            ;;
        "‚ùå –í—ã—Ö–æ–¥")
            exit 0
            ;;
    esac
done

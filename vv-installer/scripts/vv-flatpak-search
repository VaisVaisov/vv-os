#!/bin/bash
# VV OS - Flatpak Package Search (TUI)
# Search packages –≤ Flathub

set -e

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
if ! command -v gum &>/dev/null; then
    notify-send "VV Flatpak Search" "gum –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" -u critical
    exit 1
fi

if ! command -v flatpak &>/dev/null; then
    notify-send "VV Flatpak Search" "flatpak –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" -u critical
    exit 1
fi

# –ó–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
QUERY=$(gum input --placeholder "Enter package name –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ Flathub..." --prompt "üîç Flatpak: ")

if [[ -z "$QUERY" ]]; then
    exit 0
fi

# Search packages –≤ Flathub
gum spin --spinner dot --title "–ü–æ–∏—Å–∫ '$QUERY' –≤ Flathub..." -- sleep 0.5

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤ –∏–∑ Flathub
PACKAGES=$(flatpak search "$QUERY" 2>/dev/null | tail -n +1 | awk '{print $1}' | grep -v '^$' | sort -u)

if [[ -z "$PACKAGES" ]]; then
    gum style --foreground 196 "‚ùå –ü–∞–∫–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ Flathub"
    gum confirm "–ò—Å–∫–∞—Ç—å –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö?" && exec vv-pacman-search
    exit 0
fi

# –í—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞
SELECTED=$(echo "$PACKAGES" | gum filter --placeholder "Select package –∏–∑ Flathub...")

if [[ -z "$SELECTED" ]]; then
    exit 0
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–∫–µ—Ç–µ
clear
gum style \
    --border double \
    --border-foreground 45 \
    --padding "1 2" \
    --margin "1 0" \
    "üì¶ Flatpak –ø–∞–∫–µ—Ç: $SELECTED"

flatpak info "$SELECTED" 2>/dev/null || flatpak remote-info flathub "$SELECTED" | gum format

echo ""

# –î–µ–π—Å—Ç–≤–∏—è —Å –ø–∞–∫–µ—Ç–æ–º
ACTION=$(gum choose "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" "–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∞" "–û—Ç–∫—Ä—ã—Ç—å Flathub —Å—Ç—Ä–∞–Ω–∏—Ü—É" "–ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–∞–∫–µ—Ç" "–í—ã—Ö–æ–¥")

case "$ACTION" in
    "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å")
        gum confirm "Install $SELECTED –∏–∑ Flathub?" && flatpak install -y flathub "$SELECTED"
        ;;
    "–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∞")
        flatpak info --show-permissions "$SELECTED" 2>/dev/null || \
        flatpak remote-info --show-permissions flathub "$SELECTED" | less
        ;;
    "–û—Ç–∫—Ä—ã—Ç—å Flathub —Å—Ç—Ä–∞–Ω–∏—Ü—É")
        # Convert app ID to Flathub URL (e.g. com.spotify.Client -> com-spotify-Client)
        FLATHUB_ID=$(echo "$SELECTED" | tr '.' '-')
        xdg-open "https://flathub.org/apps/$SELECTED" &
        ;;
    "–ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–∞–∫–µ—Ç")
        exec "$0"
        ;;
    "–í—ã—Ö–æ–¥")
        exit 0
        ;;
esac

#!/bin/bash
# VV Snapper Manager - TUI for snapshot management

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Check if running as root
if [[ $EUID -ne 0 ]]; then
  echo -e "${RED}Error: This script must be run as root${NC}"
  echo "Usage: sudo vv-snapper-manager"
  exit 1
fi

# Check if snapper is installed
if ! command -v snapper &>/dev/null; then
  echo -e "${RED}Error: Snapper is not installed${NC}"
  exit 1
fi

# Check if btrfs
ROOT_FS=$(df --output=fstype / | tail -n1)
if [[ "$ROOT_FS" != "btrfs" ]]; then
  echo -e "${RED}Error: Root filesystem is not Btrfs (detected: $ROOT_FS)${NC}"
  echo "Snapper requires Btrfs filesystem"
  exit 1
fi

# Check if snapper config exists
if ! snapper list-configs | grep -q "root"; then
  echo -e "${YELLOW}Warning: Snapper configuration not found${NC}"
  echo "Run 'snapper -c root create-config /' to create configuration"
  exit 1
fi

show_header() {
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${CYAN}  VV Snapper Manager${NC}"
  echo -e "${CYAN}  Snapshot Management Tool${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

list_snapshots() {
  echo -e "${CYAN}Current snapshots:${NC}"
  echo ""
  snapper -c root list
  echo ""
}

create_snapshot() {
  echo -e "${CYAN}Create new snapshot${NC}"
  echo ""

  DESCRIPTION=$(gum input --placeholder "Snapshot description (e.g., Before system update)")

  if [[ -z "$DESCRIPTION" ]]; then
    echo -e "${RED}Error: Description cannot be empty${NC}"
    return 1
  fi

  echo ""
  echo -e "${YELLOW}Creating snapshot...${NC}"

  SNAPSHOT_NUM=$(snapper -c root create --description "$DESCRIPTION" --cleanup-algorithm number --print-number)

  if [[ -n "$SNAPSHOT_NUM" ]]; then
    echo -e "${GREEN}âœ“ Snapshot #$SNAPSHOT_NUM created successfully${NC}"
  else
    echo -e "${RED}âœ— Failed to create snapshot${NC}"
    return 1
  fi

  echo ""
  read -p "Press Enter to continue..."
}

delete_snapshot() {
  echo -e "${CYAN}Delete snapshot${NC}"
  echo ""

  # List snapshots
  snapper -c root list
  echo ""

  SNAPSHOT_NUM=$(gum input --placeholder "Enter snapshot number to delete")

  if [[ -z "$SNAPSHOT_NUM" ]]; then
    echo -e "${RED}Error: Snapshot number cannot be empty${NC}"
    return 1
  fi

  # Check if snapshot exists
  if ! snapper -c root list | grep -q "^\s*${SNAPSHOT_NUM}\s"; then
    echo -e "${RED}Error: Snapshot #$SNAPSHOT_NUM does not exist${NC}"
    return 1
  fi

  # Confirm deletion
  echo ""
  CONFIRM=$(gum choose --header "Delete snapshot #$SNAPSHOT_NUM?" "Yes" "No")

  if [[ "$CONFIRM" == "Yes" ]]; then
    echo ""
    echo -e "${YELLOW}Deleting snapshot #$SNAPSHOT_NUM...${NC}"

    snapper -c root delete "$SNAPSHOT_NUM"

    echo -e "${GREEN}âœ“ Snapshot #$SNAPSHOT_NUM deleted${NC}"
  else
    echo -e "${YELLOW}Deletion cancelled${NC}"
  fi

  echo ""
  read -p "Press Enter to continue..."
}

rollback_snapshot() {
  echo -e "${CYAN}Rollback to snapshot${NC}"
  echo ""
  echo -e "${YELLOW}WARNING: This will create a new read-only snapshot for rollback${NC}"
  echo -e "${YELLOW}You'll need to reboot to complete the rollback${NC}"
  echo ""

  # List snapshots
  snapper -c root list
  echo ""

  SNAPSHOT_NUM=$(gum input --placeholder "Enter snapshot number to rollback to")

  if [[ -z "$SNAPSHOT_NUM" ]]; then
    echo -e "${RED}Error: Snapshot number cannot be empty${NC}"
    return 1
  fi

  # Check if snapshot exists
  if ! snapper -c root list | grep -q "^\s*${SNAPSHOT_NUM}\s"; then
    echo -e "${RED}Error: Snapshot #$SNAPSHOT_NUM does not exist${NC}"
    return 1
  fi

  # Confirm rollback
  echo ""
  echo -e "${RED}âš  This will rollback your system to snapshot #$SNAPSHOT_NUM${NC}"
  echo -e "${RED}âš  Current state will be saved as a new snapshot${NC}"
  echo ""
  CONFIRM=$(gum choose --header "Proceed with rollback?" "Yes, rollback" "No, cancel")

  if [[ "$CONFIRM" == "Yes, rollback" ]]; then
    echo ""
    echo -e "${YELLOW}Creating rollback snapshot...${NC}"

    snapper -c root rollback "$SNAPSHOT_NUM"

    echo ""
    echo -e "${GREEN}âœ“ Rollback snapshot created${NC}"
    echo -e "${YELLOW}âš  Reboot your system to complete the rollback${NC}"
    echo ""

    REBOOT=$(gum choose --header "Reboot now?" "Yes" "No")

    if [[ "$REBOOT" == "Yes" ]]; then
      systemctl reboot
    fi
  else
    echo -e "${YELLOW}Rollback cancelled${NC}"
  fi

  echo ""
  read -p "Press Enter to continue..."
}

compare_snapshots() {
  echo -e "${CYAN}Compare snapshots${NC}"
  echo ""
  echo "This will show differences between two snapshots"
  echo ""

  # List snapshots
  snapper -c root list
  echo ""

  SNAP1=$(gum input --placeholder "First snapshot number (older)")
  SNAP2=$(gum input --placeholder "Second snapshot number (newer)")

  if [[ -z "$SNAP1" ]] || [[ -z "$SNAP2" ]]; then
    echo -e "${RED}Error: Both snapshot numbers are required${NC}"
    return 1
  fi

  echo ""
  echo -e "${CYAN}Changes between snapshots #$SNAP1 and #$SNAP2:${NC}"
  echo ""

  snapper -c root status "$SNAP1..$SNAP2" | less

  echo ""
  read -p "Press Enter to continue..."
}

show_config() {
  echo -e "${CYAN}Snapper configuration:${NC}"
  echo ""
  snapper -c root get-config
  echo ""

  echo -e "${CYAN}Automatic snapshots:${NC}"
  echo ""
  systemctl status snapper-timeline.timer --no-pager
  echo ""
  systemctl status snapper-cleanup.timer --no-pager
  echo ""

  read -p "Press Enter to continue..."
}

# Main menu loop
while true; do
  clear
  show_header

  ACTION=$(gum choose \
    "ğŸ“‹ List snapshots" \
    "â• Create snapshot" \
    "ğŸ—‘ï¸  Delete snapshot" \
    "â†©ï¸  Rollback to snapshot" \
    "ğŸ” Compare snapshots" \
    "âš™ï¸  Show configuration" \
    "âŒ Exit")

  echo ""

  case "$ACTION" in
    "ğŸ“‹ List snapshots")
      list_snapshots
      read -p "Press Enter to continue..."
      ;;
    "â• Create snapshot")
      create_snapshot
      ;;
    "ğŸ—‘ï¸  Delete snapshot")
      delete_snapshot
      ;;
    "â†©ï¸  Rollback to snapshot")
      rollback_snapshot
      ;;
    "ğŸ” Compare snapshots")
      compare_snapshots
      ;;
    "âš™ï¸  Show configuration")
      show_config
      ;;
    "âŒ Exit")
      echo -e "${CYAN}Goodbye!${NC}"
      exit 0
      ;;
  esac
done
